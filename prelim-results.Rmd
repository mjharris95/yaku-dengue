---
title: "Winter 2024: Cyclone Yaku and Dengue"
output:
 bookdown::html_document2:
    number_sections: yes
    toc: yes
date: "2023-12-21"
bibliography: references.bib
---

```{=html}
<style>
p.caption {
  color: grey;
  font-size: 0.9em;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, cache=TRUE, message=FALSE, eval=TRUE)

library(tidyverse)
library(magrittr)
library(lubridate)
library(sf)
library(biscale)
library(cowplot)
library(bookdown)
library(viridis)
library(aweek)
library(googledrive)
library(aweek)
library(microsynth)

# extreme_prov <- c("PE1401", "PE2402", "PE1402", 
#      "PE1403", "PE2004", "PE2005",
#      "PE2001", "PE2008", "PE2006",
#      "PE2007", "PE2401", "PE2403") 

```

Mean temperature and total precipitation reported hourly in the ECMWF ERA5-Land Hourly reanalysis dataset were extracted using Google Earth Engine. Given evidence of temperature biases in this dataset relative to Global Historical Climatology Network (GHCN) weather stations, particularly at high elevations, we debiased hourly temperature by comparison to monthly average temperatures reported by the high resolution climatology WorldClim between 1970 and 2000 following [@childs], using the equation:

$\widehat{ERA5_{ihmy}} = ERA5_{ihmy} - \overline{ERA5_{im}}+\overline{WorldClim_{im}}$

where $\widehat{ERA5_{ihmy}}$ is the debiased ERA5 hourly temperature in a given province (where the subscripts i, h, m, and y indicate the mean temperature in a given province, hour, month, and year respectively), $ERA5_{ihmy}$ is the raw ERA5 hourly temperature in the corresponding province, $\overline{ERA5_{im}}$ and $\overline{WorldClim_{im}}$ are the mean monthly temperatures for a given province from 1970 - 2000 from ERA5 and WorldClim respectively. We then calculated the average temperature and precipitation across a given spatial region by taking a population-weighted average (e.g., weighting by the proportion of the total population living in a given 100m x 100m grid cell). Population estimates are based on WorldPop residential population estimates for 2020.

Ecuador and Peru have three broad climatic regions from west to east: the dry Pacific coastline, the cool Andes mountains, and the warm and wet Amazon rainforest (Figure\@ref(fig:peru-weather)A). Tropical Cyclone Yaku, which was first formed on March 7th 2023 and dissipated on March 20th, primarily impacted the northern coast of Peru along with parts of Ecuador (Figure\@ref(fig:peru-weather)B). Although some northeastern regions in the Amazon basin also experienced anomalously heavy precipitation during Cyclone Yaku, we focus our analysis on those in the first percentile for precipitation (i.e., particularly dry provinces that experience less than 5.4 mm of rain per day on average) that experienced anomalous precipitation during Cyclone Yaku (exceed the 95th percentile of their distribution for biweekly cumulative precipitation across thirty years) (Figure\@ref(fig:peru-weather)C). Five provinces meet these criteria: three northwestern coastal regions in Peru (Lambayeque [PE14], Piura [PE20], and Tumbes [PE24]) and two coastal provinces in Ecuador (ManabÃ­ [EC13] and Santa Elena [EC24]). These selection criteria for the treated provinces reflect the hypothesized mechanism whereby regions with a dry climate that experience heavy precipitation may be particularly vulnerable to dengue outbreaks, as water storage practices and lack of infrastructure to prevent flooding may promote formation of new vector breeding habitat.

```{r peru-weather, fig.width=10, fig.cap="Climate conditions across regions in Peru and provinces in Ecuador from 1993 - 2023 compared to during Cyclone Yaku. In all panels, the bolded outline encompasses locations included in treated group. (A) A bivariate plot where locations are shaded according to mean temperature and mean precipitation compared to other regions from 1993 - 2023. Redder tones indicate warmer locations and bluer tones indicate locations with more precipitation. (B) Locations are shaded according to the total amount of precipitation received during Cyclone Yaku, from March 7th - March 20th, 2023. (C) Locations are shaded according to the percentile for biweekly cumulative precipitation experienced during Cyclone Yaku, compared to the distribution of biweekly cumulative precipitation from 1993 - 2023. Darker shades indicate locations that experienced more precipitation than usual during Cyclone Yaku."}

map <- read_sf("shapes/per_admbnda_adm1_ign_20200714.shp") %>%
        st_simplify() %>%
        mutate(pcode = ADM1_PCODE) %>%
        select(geometry, pcode)

df <- read.csv("weather-processed/PER_weather.csv") %>%
        pivot_wider(names_from=property, values_from=mean) %>%
        mutate(dates = as.Date(date)) %>%
        mutate(pcode = ADM1_PCODE) %>%
        select(pcode, dates, temperature_2m, total_precipitation)

map <- read_sf("shapes/ecu_admbnda_adm1_inec_20190724.shp") %>%
        st_simplify() %>%
        mutate(pcode = ADM1_PCODE) %>%
        select(geometry, pcode) %>%
        rbind(map)

df <- read.csv("weather-processed/ECU_weather.csv") %>%
        pivot_wider(names_from=property, values_from=mean) %>%
        mutate(dates = as.Date(date)) %>%
        mutate(pcode = ADM1_PCODE) %>%
        select(pcode, dates, temperature_2m, total_precipitation) %>%
        rbind(df)

# bivariate temp vs precip
bi_df <- df %>%
     group_by(pcode) %>%
        summarize(temp = mean(temperature_2m),
                  rain = mean(total_precipitation)) %>%
        bi_class(x = temp, y=rain, style="quantile", dim=3)

bi_plot <- bi_df %>%
            merge(map, .) %>%
             ggplot() + 
                geom_sf((aes(fill=bi_class)), show.legend=FALSE)+
                theme_void()+
                bi_scale_fill(pal="GrPink", dim=3) +
            bi_theme()

legend <- bi_legend(pal="GrPink", dim = 3,
                    xlab= "Warmer", ylab="Wetter", size=6)+
          ggtitle("Climate \n(1993 - 2023)")


# precipitation during yaku
df %>%
        filter(dates >= as.Date("2023-03-07") & dates <= as.Date("2023-03-20")) %>%
        group_by(pcode) %>%
        summarize(yaku_rain = sum(total_precipitation)) %>%
        merge(map, .) %>%
         ggplot() + 
            geom_sf((aes(fill=yaku_rain)))+
            theme_void()+
            scale_fill_viridis_c("Cumulative \nPrecipitation \n(During Yaku)",  option = "mako", direction=-1) -> p1b


df %>%
  mutate(week = week(dates-2),
         year = year(dates-2)) %>%
  mutate(biweek = floor(week/2)) %>%
  #filter(week!=53) %>% # note that this is producing some partial weeks
  group_by(pcode, biweek, year) %>%
        summarize(rain = sum(total_precipitation)) %>%
  ungroup() %>%
  group_by(pcode) %>%
        reframe(percentile = cume_dist(rain),
               biweek = biweek,
               year = year,
               rain = rain) %>% 
  filter(biweek == 5 & year == 2023) -> percentile_df

write.csv(percentile_df, "percentile_df.csv", row.names=FALSE)

percentile_df %>% 
  left_join(bi_df %>% select(pcode, bi_class)) %>%
  merge(map, .)-> percentile_map

percentile_map %>% filter(percentile >= .9) %>%
                filter(substr(bi_class, 3,3)=="1") %>%
                filter(pcode!="EC20") %>%
                summarise(id = "extreme") -> extreme_map

ggplot() + 
    geom_sf(data=percentile_map, (aes(fill=percentile)))+
    theme_void()+
    scale_fill_viridis_b("Precipitation \nPercentile \n(During Yaku)", na.value="white", option = "mako", direction=-1) -> p1c


ggdraw()+
  draw_plot(bi_plot + geom_sf(data = extreme_map, col = "black", alpha = 0, linewidth = .5), 0, 0, 1, 1)+
  draw_plot(legend, 0, 0, .3, .3) -> p1a


plot_grid(p1b + geom_sf(data = extreme_map, col = "grey", alpha = 0, linewidth = .5), 
           p1c + geom_sf(data = extreme_map, col = "grey", alpha = 0, linewidth = .5), 
           labels=c("B.", "C."), nrow=2, hjust=0, vjust=1) %>%
   plot_grid(p1a, ., labels=c("A.", ""), ncol=2, hjust=0, vjust = 1)




```

Dengue cases are predominantly reported on the Pacific coast and in the Amazon basin, with many provinces in the Andes highlands not reporting any cases from 2010 onward. Several of the provinces most affected by Cyclone Yaku in Peru have a relatively high mean weekly dengue incidence compared to other provinces (Figure \@ref(fig:peru-dengue)A). During Cyclone Yaku, these provinces had a mean incidence of XX compared to an average incidence of XX across other dengue-endemic provinces, but we do not observe elevated incidence in treated provinces in Ecuador (Figure \@ref(fig:peru-dengue)B). As shown in Figure \@ref(fig:peru-dengue)C, many of the provinces with the most anomalously high precipitation also had the greatest dengue incidence in the weeks following the outbreak.

```{r peru-dengue, fig.width = 10, fig.cap="weekly dengue incidence across provinces in Peru from 2013 - 2022 compared to the 2023 outbreak. In all panels, the bolded outline encompasses the group of northwestern provinces most affected by Cyclone Yaku, used as the treatment group in the synthetic control analysis. Provinces in white had no reported dengue from 2013 - 2023. (A) Provinces are shaded according to their mean weekly dengue incidence across the time series prior to Cyclone Yaku (2013-2022). (B) Provinces are shaded according to their mean weekly dengue incidence in the weeks following Cyclone Yaku (week 10 - 26 of 2023). (C) A bivariate plot where provinces are shaded according to their precipitation anomaly during Cyclone Yaku and dengue incidence in the weeks following the cyclone. More pink tones indicate provinces with greater dengue incidence and more blue tones indicate provinces with a greater anomaly in precipitation (e.g., high precipitation compared to their typical weather)."}

case_df <- read.csv("cases/PER_cases.csv") %>%
                mutate(ADM1_PCODE = toupper(ADM1_PCODE)) %>%
                rename(pcode=ADM1_PCODE) %>%
                select(year, week, cases, pop, pcode) %>%
                filter(!is.na(cases))

case_df <- read.csv("cases/ECU_weekly_cases.csv") %>%
                mutate(ADM1_PCODE = toupper(ADM1_PCODE)) %>%
                rename(pcode=ADM1_PCODE) %>%
                select(year, week, cases, pop, pcode) %>%
                rbind(case_df)

case_df %<>% mutate(inc = cases/pop)  %>% 
  filter(year >= 2013)

df <- read.csv("weather-processed/PER_weather.csv") %>%
        pivot_wider(names_from=property, values_from=mean) %>%
        mutate(dates = as.Date(date)) %>%
        rename(pcode = ADM1_PCODE)

df <- read.csv("weather-processed/ECU_weather.csv") %>%
        pivot_wider(names_from=property, values_from=mean) %>%
        mutate(dates = as.Date(date)) %>%
        rename(pcode = ADM1_PCODE) %>%
        rbind(df)

map <- rbind(read_sf("shapes/per_admbnda_adm1_ign_20200714.shp") %>% 
               st_simplify() %>% 
               select(geometry, ADM1_PCODE) %>% 
               rename(pcode=ADM1_PCODE),
             read_sf("shapes/ecu_admbnda_adm1_inec_20190724.shp") %>% 
               st_simplify() %>% 
               select(geometry, ADM1_PCODE) %>% 
               rename(pcode=ADM1_PCODE))

missing_prov <- setdiff(unique(map$pcode), unique(case_df$pcode)) 

times <- dplyr::filter(case_df, pcode == "PE01") %>%
          select(year, week)


# fill out provinces that are missing with NAs
for(prov in missing_prov){
  prov_df <- cbind(times, pcode = prov, cases = NA, pop=NA, inc = NA)
  case_df %<>% rbind(prov_df)
}

case_df %>% 
  group_by(pcode) %>% 
  filter(year >= 2013 & year <=2023) %>%
  summarize(total_cases = mean(inc)) %>%
  merge(map, .) %>%
   ggplot() + 
      geom_sf((aes(fill=total_cases)))+
      theme_void()+
      scale_fill_viridis_c("Average pre-outbreak \nincidence", option = "rocket", direction = -1, na.value="white") -> p2b



# This will be cases during the outbreak, right now it's during a random week of 2020
case_df %>% 
  dplyr::filter(year == 2023 & week >= 10) %>%
  group_by(pcode) %>% 
  summarize(outbreak_cases = mean(inc)) %>%
  merge(map, .) %>%
   ggplot() + 
      geom_sf((aes(fill=outbreak_cases)))+ 
      theme_void()+
      scale_fill_viridis_c("Average post-outbreak \n incidence", option = "rocket", direction = -1, na.value="white") -> p2c

# This will be a bivariate plot of cases after the outbreak vs rain during outbreak
left_join(
  case_df %>% 
    dplyr::filter(year == 2023 & week >= 10) %>%
    group_by(pcode) %>% 
    summarize(outbreak_cases = mean(inc)), 
  percentile_df) %>%
bi_class(x = outbreak_cases, y=percentile, style="equal", dim=3) %>%
        merge(map, .) %>%
         ggplot() + 
            geom_sf((aes(fill=bi_class)), show.legend=FALSE)+
            theme_void()+
            bi_scale_fill(pal="DkBlue2", dim=3, flip_axes = TRUE, na.value="white") +
        bi_theme()  + geom_sf(data = extreme_map, col = "black", alpha = 0, linewidth = .5) -> case_rain_plot

legend <- bi_legend(pal="DkBlue2", dim = 3, flip_axes = TRUE,
                    xlab= "More Dengue", ylab="Extreme Rain", size=6) 

ggdraw()+
  draw_plot(case_rain_plot + geom_sf(data = extreme_map, col = "black", alpha = 0, linewidth = .5), 0, 0, 1, 1)+
  draw_plot(legend, 0, 0, .3, .3) -> p2a

plot_grid(p2b + geom_sf(data = extreme_map, col = "black", alpha = 0, linewidth = .5), 
          p2c + geom_sf(data = extreme_map, col = "black", alpha = 0, linewidth = .5), labels=c("A.", "B."), nrow=2, hjust=0, vjust=1) %>%
   plot_grid(., p2a, labels=c("", "C."), ncol=2, hjust=0, vjust = 1) 





```

Here, we demonstrate using a synthetic control method to evaluate the impact of the cyclone on the treated provinces (those impacted by the cyclone) compared to the synthetic control, a set of untreated provinces selected by matching on dengue cases (logged), temperature, and precipitation prior to Cyclone Yaku and logged population size (in 2020), aggregating weekly variables to four-week periods. The pool of untreated units used to construct the synthetic control includes locations in Mexico, Brazil, and Colombia.To avoid including provinces that also may have been impacted by Yaku, we remove provinces in Peru and Ecuador that experienced precipitation above their 80th percentile during the biweek of Cyclone Yaku, which may experience some treatment effect and bias our analysis toward underestimating the cyclone's impact.

We use two different approaches. First, we apply the microsynth package to estimate a treatment effect across all the treated provinces, essentially taking an average across the five units to collapse them into a "macroprovince." Each control unit is then assigned a weight such that the weighted average of time-varying mean temperature, precipitation, and cases (logged) across these control regions approximates those in the treated group prior to the cyclone. We additionally match on population (logged). The effect of the Cyclone is then estimated as the difference in cases between the treated provinces and their synthetic control [@abadie2003a] .

The synthetic control is able to match most of the outbreaks in the treated provinces, particularly since 2020 (Figure\@ref(fig:synth-control-cases)A). The synthetic control is generally a bit cooler than the treated provinces, which is generally hotter than the mean temperature across all locations in the untreated pool (Figure\@ref(fig:synth-control-cases)B). Similarly, the synthetic control generally matches the relative dryness of the treated provinces, although there is a large mismatch in 2017 when synthetic control was considerably more dry than the treated provinces (Figure\@ref(fig:synth-control-cases)C). Cases in the treated provinces increased by a factor of 4.3 following the cyclone, and this increase was statistically significantly (p = 0.008, estimated using permutation tests)\@ref(fig:synth-control-cases)D).

```{r synth-control-run, eval=FALSE}

load("synthetic-peru-global.RData")
full_df %<>% filter(! name %in% remove_prov) 

#write.csv(df, "peru-forsynth.csv", row.names=FALSE)

ms_df <- full_df  %>% 
            filter(!is.na(mean_temp)) %>% 
             mutate(pop = log(pop)) #%>%
            # mutate(mean.log_cases = mean(log_cases),
            #        mean.mean_temp = mean(mean_temp),
            #        mean.precip = mean(precip),
            #        mean.pop = mean(pop),
            #        sd.log_cases = sd(log_cases),
            #        sd.mean_temp = sd(mean_temp),
            #        sd.precip = sd(precip),
            #        sd.pop = sd(pop)) %>%
            # mutate(log_cases = (log_cases)/sd.log_cases,
            #        mean_temp = (mean_temp)/sd.mean_temp,
            #        precip = (precip)/sd.precip,
            #        pop = (pop)/sd.pop)

synth_clim <- microsynth(ms_df,
                         idvar="name",
                         timevar="time",
                         intvar="int",
                         match.out = c("log_cases","mean_temp", "precip"),
                         match.covar = "pop", #NOTE: I am missing population for some countries?
                         check.fea=TRUE,
                         use.backup = TRUE,
                         perm = 500, 
                         n.cores=1)

save(ms_df, synth_clim, file="synthetic-peru-global.RData")

```

```{r synth-control-cases, fig.height=10, fig.width=10, fig.cap="Synthetic control results where three treated Peru regions were matched to locations in Peru, Colombia, Mexico, Ecuador, and Brazil. (A) Dengue incidence aggregated to four-week periods from 2010 - 2023 across the treated provinces (black), the synthetic control (maroon), and all untreated province (grey). The dashed vertical line indicates when Cyclone Yaku occured. Panels B and C similarly display temperature and precipitation over time in the treated, synthetic control, and all untreated province. (D) The difference in cases between the treated and synthetic control provinces over time. Values above the dashed vertical line indicate greater incidence in the treated compared to synthetic control provinces. Each grey line is the result of a permutation test for comparison. Panels E and F similarly display the difference in temperature and precipitation over time. (G) Weighting of provinces in constructing the synthetic control. Treated provinces are indicated in pink. Excluded provinces are indicated in grey. [NOTE: I know the color scheme is bad for now, allows more flexibility until we have actual results]"}
     
load("synthetic-peru-global.RData")
 
source("plot-functions.R")   

plot_synth(synth_clim, "log_cases", var_name = "Cases (log)", legend.pos = "bottom") -> inc_res
plot_synth(synth_clim, "mean_temp", var_name = "Temp.", legend.pos = "none") -> temp_res
plot_synth(synth_clim, "precip", var_name = "Precip.", legend.pos = "none") -> rain_res 
plot_diff(synth_clim, "log_cases", var_name = "Cases (log)", placebo=TRUE) -> inc_diff 
plot_diff(synth_clim, "mean_temp", var_name = "Temp.", placebo=TRUE) -> temp_diff 
plot_diff(synth_clim, "precip", var_name = "Precip.", placebo=TRUE) -> rain_diff  

leg <- get_legend(inc_res)
inc_res <- inc_res + theme(legend.position="none")

# ecu_map <- read_sf("ecu_admbnda_adm1_inec_20190724.shp") %>%
#             st_simplify() %>%
#             select(geometry, ADM1_PCODE) %>%
#             rename(name = ADM1_PCODE)
# 
# per_map <- read_sf("per_admbnda_adm1_ign_20200714.shp") %>%
#             st_simplify() %>%
#             select(geometry, ADM1_PCODE) %>%
#             rename(name = ADM1_PCODE)
# 
# col_map <- read_sf("col_admbnda_adm1_mgn_20200416.shp") %>%
#             st_simplify() %>%
#             select(geometry, ADM1_PCODE) %>%
#             rename(name = ADM1_PCODE)
# 
# bra_map <- read_sf("bra_admbnda_adm1_ibge_2020.shp") %>%
#             st_simplify() %>%
#             select(geometry, ADM1_PCODE) %>%
#             rename(name = ADM1_PCODE) %>%
#             st_set_crs("+proj=longlat +datum=WGS84 +no_def")
# 
# mex_map <- read_sf("mex_admbnda_adm1_govmex_20210618.shp") %>%
#             st_simplify() %>%
#             select(geometry, ADM1_PCODE) %>%
#             rename(name = ADM1_PCODE)
# 
# five_map <- rbind(per_map, col_map, bra_map, mex_map, ecu_map)
# save(five_map, file="five_map.RData")   

load("five_map.RData")
   
plot_weights_peru(synth_clim, five_map) -> weight_map 

plot_grid(inc_res, temp_res, rain_res, ncol=1, labels=c("A.", "B.", "C.")) -> left
plot_grid(inc_diff, temp_diff, rain_diff, ncol=1, labels=c("D.", "E.", "F.")) -> right
plot_grid(left, right, ncol=2) %>%
  plot_grid(., leg, weight_map, labels=c("","","G."), rel_heights = c(10,1,10), nrow=3)    

```


WORK IN PROGRESS BELOW
When each provinces in the synthetic control are disaggregated and the workflow is repeated for each province separately, we find evidence of a significant increase in cases following the cyclone in Peru but not Ecuador. 

```{r placebo_demo, eval=FALSE}
load("synthetic-peru-global.RData")
source("plot-functions.R") 
load("five_map.RData")

# map of which are in the treated group for perm1 
perm_df <- data.frame("name" = names(synth_clim$w$Intervention[,2]),
                      "perm1" = synth_clim$w$Intervention[,2],
                      "perm2" = synth_clim$w$Intervention[,3],
                      "perm10" = synth_clim$w$Intervention[,11])

cols <- rev(rainbow(10))

five_map %>% merge(perm_df) %>%
  ggplot() +
  geom_sf(aes(fill=perm1))+
  scale_fill_manual(values = c("TRUE"=cols[1], "FALSE"="white"))+
  theme_void()+
  theme(legend.position="none")

# line -> diff for perm1
plot_diff_explainer(synth_clim, "log_cases", var_name = "Cases (log)", perm_num=1)

# map of which are in the treated group for 2
five_map %>% merge(perm_df) %>%
  ggplot() +
  geom_sf(aes(fill=perm2))+
  scale_fill_manual(values = c("TRUE"=cols[2], "FALSE"="white"))+
  theme_void()+
  theme(legend.position="none")

# line -> diff for perm2
plot_diff_explainer(synth_clim, "log_cases", var_name = "Cases (log)", perm_num=2)
 
# line -> diff for perm1-10
plot_diff_explainer(synth_clim, "log_cases", var_name = "Cases (log)", perm_num=10) 

# map of which are in the treated group for 2
five_map %>% merge(perm_df) %>%
  ggplot() +
  geom_sf(aes(fill=perm10))+
  scale_fill_manual(values = c("TRUE"=cols[10], "FALSE"="white"))+
  theme_void()+
  theme(legend.position="none")



```

```{r disagg-synth, eval=FALSE, fig.height=8}
library(microsynth) 

load('global-forsynth.RData') # from data-prep script
extreme_prov <- c("PE14", "PE20", "PE24", "EC13", "EC24") 

# provinces to remove because they are above 80th percentile or have no cases
remove_prov <- c("EC01", "EC02", "EC03", "EC04",  "EC05", "EC06", "EC07",
  "EC08", "EC09", "EC11", "EC12", "EC14", "EC15",
  "EC16", "EC18", "EC19", "EC21", "EC22", "EC23",
  "EC90", "PE01", "PE13", "PE16", "PE22", "EC20",
  "MX09", "MX29")

full_df %<>% mutate(int = ifelse(name %in% extreme_prov & time >= as.Date("2023-03-07"), 1, 0))

ms_df <- full_df %>%
          filter(! name %in% remove_prov) %>%
          mutate(pop = log(pop)) %>%
          filter(! is.na(mean_temp)) %>%
          filter(year>=2018)

# transform_df <- data.frame(var = c("mean_temp", "r0", "precip", "log_cases", "pop"),
#                            min = c(min(ms_df$mean_temp),
#                                   min(ms_df$r0),
#                                   min(ms_df$precip),
#                                   min(ms_df$log_cases),
#                                   min(unique(ms_df$pop))),
#                            sd = c(sd(ms_df$mean_temp),
#                                   sd(ms_df$r0),
#                                   sd(ms_df$precip),
#                                   sd(ms_df$log_cases),
#                                   sd(unique(ms_df$pop))))
# 
# ms_df <- ms_df %>%
#           mutate(mean_temp = (mean_temp-transform_df$min[transform_df$var == "mean_temp"])/transform_df$sd[transform_df$var == "mean_temp"],
#                  r0 = (r0-transform_df$min[transform_df$var == "r0"])/transform_df$sd[transform_df$var == "r0"],
#                  precip = (precip-transform_df$min[transform_df$var == "precip"])/transform_df$sd[transform_df$var == "precip"],
#                  log_cases = (log_cases-transform_df$min[transform_df$var == "log_cases"])/transform_df$sd[transform_df$var == "log_cases"],
#                  pop = (pop-transform_df$min[transform_df$var == "pop"])/transform_df$sd[transform_df$var == "pop"])


synth_clim <- list()

for(prov in unique(ms_df$name)){
  ms_df2 <- ms_df %>% filter(! name %in% setdiff(extreme_prov, prov))
  
  if(!prov %in% extreme_prov){
    ms_df2 <-  ms_df2 %>% mutate(int = ifelse(name == prov & time >= as.Date("2023-03-07"), 1, 0))
  }
  
  synth_clim[[prov]] <- microsynth(ms_df2,
                     idvar="name",
                     timevar="time",
                     intvar="int",
                     match.out = c("log_cases", "r0", "precip"),
                     match.covar = "pop", #NOTE: I am missing population for some countries?
                     check.fea=TRUE,
                     use.backup = TRUE,
                     n.cores=1)
  
  #print(length(synth_clim))
}

save(synth_clim, ms_df, file="disagg-synth.RData")

```

```{r plot-each, fig.height=12, fig.cap="This figure is a work in progress, but the top panel mirrors 3A-3C for each of the treated provinces, labeled on the left hand side. The bottom panel is similar to Fig 3D, but each line indicates the treatment effect of logged cases for individual provinces. The dark lines are treated provinces and the gray lines are untreated provinces (placebo). The treated provinces are labeled on the right side of the figure with their ADM1 pcode. Note that provinces are arranged from north to south: EC24, EC13, PE24, PE20, PE14."}
load("disagg-synth.RData")
source("plot-functions.R")
extreme_prov <- c("PE14", "PE20", "PE24", "EC13", "EC24")   

p <- list() 


for(prov in extreme_prov){ 
  p[[prov]] <- list()
  p[[prov]][[1]] <- plot_synth(synth_clim[[prov]], 
                              # transform_df = transform_df,
                               var_name = "Cases",
                               var="log_cases", legend.pos="none", div=1)
  p[[prov]][[2]] <- plot_synth(synth_clim[[prov]], 
                               #transform_df = transform_df, 
                               var_name= "R0",
                               var="r0", legend.pos="none", div=1)
  p[[prov]][[3]] <- plot_synth(synth_clim[[prov]], 
                               #transform_df = transform_df, 
                               var_name = "Rain",
                               var="precip", legend.pos="none", div=1)
                              
}

leg <- get_legend(plot_synth(synth_clim[[1]], var="log_cases", legend.pos="bottom"))
 
 
row <- list() 


for(i in c(1:5)){
  plot_row <-  plot_grid(p[[i]][[1]], p[[i]][[2]], p[[i]][[3]], cols=3)
  # now add the title
  title <- ggdraw() + 
    draw_label(
      extreme_prov[i],
      fontface = 'bold',
      x = 0,
      hjust = 0
    ) +
    theme(
      # add margin on the left of the drawing canvas,
      # so title is aligned with left edge of first plot
      plot.margin = margin(0, 0, 0, 7)
    )
  plot_grid(
    title, plot_row,
    ncol = 1,
    # rel_heights values control vertical title margins
    rel_heights = c(0.2, 1)
  ) -> row[[i]]
}

# reordering to Manabi, Santa Elena, Tumbes, Piura, Lambayeque (to follow north-south)
plot_grid(row[[5]], row[[4]], row[[3]], row[[2]], row[[1]], rows=5) %>%
plot_grid(., leg, rows=2, rel_heights=c(10, 1)) -> top

plot_multidiff(synth_clim, "log_cases", extreme_prov, var_name="Cases (logged)") -> bottom

plot_grid(top, bottom, nrow=2, rel_heights=c(2, 1))


```

<!-- Next steps: -->

<!-- -   Implement synthetic control in each treated province separately to facilitate comparison of the cyclone's impact between units and enable more precise matching (may consider using the Generalized Synthetic Control Method [@xu2017]). I have started this in Figure 4 below. There is obvious heterogeneity in the treatment effect between provinces. -->
<!-- -   I'm planning to test how varying the thresholds for control/placebo (currently above 95th percentile and below 80th respectively) affects the results. Are our findings robust to these thresholds? Or can we detect some evidence of a dose-response relationship between precipitation and dengue? -->
<!-- -   Normalize all variables by taking z-score, as there is considerable variation in the mean/standard deviation of the variables currently that may weight matching toward certain variables in an odd way -->
<!-- -   I am looking into ways to assess the quality of the match more systematically -->
<!-- -   The analysis would be stronger if we can extend the timescale past July 2023. We are currently limited because Colombia and Brazil have not published data past that point yet, but cases surged well past then. We are therefore likely underestimating the cyclone's impacts. -->
<!-- -   The analysis would also be stronger if we can conduct it at a finer spatial scale, allowing us to be more precise about the climatic conditions (rather than averaging across an entire province). This would also expand the size of our pool of control units, which also may improve match quality. I have adm2 and adm3 data from most countries, but have not been able to identify a source that continues through 2024 for these data in Peru. -->
<!-- -   There also was a severe El NiÃ±o in 2017. It may be worth explicitly accounting for/studying that as an additional extreme event that affected many of the same provinces. -->
<!-- -   I would also like to connect with a climate modeler who could assess the extent to which climate change increased the likelihood or severity of Cyclone Yaku. Those results could then be linked to this study in a two-step attribution analysis connecting climate change to a health outcome. -->

<!-- This will be a table that gives some statistics on climate variables and cyclone effect. I would not trust it yet, though - I know some of these values are incorrect/miscalculated. -->

```{r att-each, eval=FALSE}
load("synthetic-peru-global.RData")
load("disagg-synth.RData")
source('plot-functions.R')

extreme_df <- data.frame(ADM1_PCODE = c("PE14", "PE20", "PE24", "EC13", "EC24"))

extreme_df <- rbind(
  read.csv("cases/PER_cases.csv") %>% 
    select(ADM1_PCODE, id) %>% 
    distinct(),
  read.csv("cases/ECU_weekly_cases.csv") %>% 
    select(ADM1_PCODE, Provincia) %>% 
    rename(id = Provincia) %>%
    distinct()) %>%
  right_join(extreme_df) 

ms_df %>% filter(name %in% extreme_df$ADM1_PCODE & time <= as.Date("2020-03-07")) %>%
          group_by(name) %>%
          summarize("temp (pre-yaku)" = mean(mean_temp),
                    "rain (pre-yaku)" = mean(precip),
                    "cases (pre-yaku)" = mean(cases),
                    "pop" = max(exp(pop))) %>%
          rename(ADM1_PCODE = name) %>%
          right_join(extreme_df) -> extreme_df

read.csv("percentile_df.csv") %>%
  rename(ADM1_PCODE = pcode) %>%
  mutate("rain (during yaku)" = rain/14) %>%
  select("rain (during yaku)", percentile, ADM1_PCODE) %>%
  right_join(extreme_df) -> extreme_df
  
ms_df %>% filter(name %in% extreme_df$ADM1_PCODE & time > as.Date("2020-03-07")) %>%
          group_by(name) %>%
          summarize("cases (post-yaku)" = mean(cases)) %>%
          rename(ADM1_PCODE = name) %>%
          right_join(extreme_df) -> extreme_df

tab_multidiff(synth_clim, "log_cases", extreme_df$ADM1_PCODE) %>%
  data.frame() %>%
  right_join(extreme_df) -> extreme_df

extreme_df
```

```{r try-gsynth, fig.height=10, eval=FALSE}

load('global-forsynth.RData')
extreme_prov <- c("PE14", "PE20", "PE24", "EC13", "EC24") 

# provinces to remove because they are above 80th percentile or have no cases
remove_prov <- c("EC01", "EC02", "EC03", "EC04",  "EC05", "EC06", "EC07",
  "EC08", "EC09", "EC11", "EC12", "EC14", "EC15",
  "EC16", "EC18", "EC19", "EC21", "EC22", "EC23",
  "EC90", "PE01", "PE13", "PE16", "PE22", "EC20",
  "MX09", "MX29")

full_df %<>% mutate(int = ifelse(name %in% extreme_prov & time >= as.Date("2023-03-07"), 1, 0))

ms_df <- full_df %>%
          filter(! name %in% remove_prov) %>%
          mutate(pop = log(pop)) %>%
          filter(! is.na(mean_temp))

p<-list()
d<-list()
out<-list()
for(prov in extreme_prov){
  gsynth(log_cases ~ int + mean_temp + precip, 
         data=ms_df %>% filter(!name %in% setdiff(extreme_prov, prov)), 
         index=c("name", "time"),
         force = "none", se=TRUE, 
         inference="parametric", nboots=100) -> out[[prov]]
  p[[prov]] <- plot(out[[prov]], type="counterfactual", id=prov, raw="band")
  d[[prov]] <- plot(out[[prov]], id = prov)
}

plot_grid(p$PE14, p$PE20, p$PE24, p$EC13, p$EC24)
plot_grid(d$PE14, d$PE20, d$PE24, d$EC13, d$EC24)

```
